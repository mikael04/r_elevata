---
title: "Visão do gestor"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
params:
  variable1: "emp_par"
---

```{r setup, include=FALSE}
#rm(list = ls())
#Lib q será futuramente usada pros painéis interativos
#library(shiny)
#Lib pra conexão com o banco
library(odbc)
library(tidyverse)
#Libs pra trabalhar com a base (cortes e funções similares ao SQL)
#library(dplyr) #Contido no tidyverse
#Lib pro gráfico
library(ggplot2)
#lib pros gráficos mais "interativos"
library(plotly)
library(highcharter)
#library(htmlwidgets)
#Lib pra usar paletas de cores
library(RColorBrewer)
#library(viridis)
#Lib usada pros treemaps
#library(treemap)
#Lib usada pros waffles
#library(waffle)
#usada para converter números em moeda
library(scales)
#Lib pra mexer com as fontes
library(extrafont)


###################################
##Variáveis "Globais"
####Variavel de teste para não remover e imprimir valores de teste, 1 para teste, 0 para não estou testando, rodando
teste = F
####Variável para testar empresa individualmente
teste_d = F
####Variável usada para não plotar os gráficos na dash
dash = T
####Variavel global c/ ano atual (para comparação)
ano_atual = '2020-01-01'
####Variável global para ver se tem usados Ainda não usada
#usados = T



##Variável "Global"
emp_am = 42 # Amazonia
emp_ar = 77 # Araguaia
emp_ko = 78 # Komatsu
emp_ms = 35 # Ms
emp_si = 59 # Simex 
emp_su = 16 # Super
emp_ta = 60 # Taisa

##Empresa utilizada
if (params$variable1 == 'Super'){
  empresa = emp_su
} else{
  if(params$variable1 == 'Komatsu'){
    empresa = emp_ko
  }
}
#teste_d = T
##teste
if (teste_d == T){
  empresa = 0;
  #empresa = emp_su
}
###################################

##Alterar o nome completo pra primeiro nome mais iniciais dos sobrenomes
func_nome <- function (nome_comp)
{
  lista <- str_split_fixed(nome_comp, " ", 4)
  lista <- lista[, -4]
  lista[,3] = str_sub(lista[,3], 1, 1)
  lista[,2] = str_sub(lista[,2], 1, 1)
  lista[,2] = paste(lista[,2], '.', sep='')
  lista[,3] = paste(lista[,3], '.', sep='')
  lista[,2] <- gsub('^.$', '',lista[,2])
  lista[,3] <- gsub('^.$', '',lista[,3])
  lista[,1] <- paste(lista[,1], lista[,2], lista[,3], sep=' ')
  return (lista[,1])
}

##Alterar o número apresentado na forma americana (com vírgula) para a forma brasileira (com ponto), através da transformação em string
func_fmt_numbr <- function(inteiro)
{
  inteiro_br <- paste("", format(inteiro, decimal.mark = ",", big.mark = ".", nsmall = 2))
  return(inteiro_br)
}

con <- DBI::dbConnect(odbc::odbc(),
                      Driver = 'SQL Server',
                      Server = 'localhost\\SQLEXPRESS01',
                      Database = 'nhmobile_agriculture',
                      Trusted_Connection = 'True')

##Collect cria o df resultado da query, nesse caso, visitas_cliente
visita_cliente <- tbl(con,'visita_cliente') %>%
  select (vc_id, vc_vendedor_id, vc_cliente_id, vc_status_id, vc_resultado_id, vc_data_cadastro) %>%
  filter (vc_data_cadastro >= ano_atual) %>%
  collect ()
##Pra pegar o nome do resultado
visita_resultado <- tbl(con, "visita_resultado") %>%
  select(vr_id, vr_nome, vr_ativo) %>%
  #filter(vre_ativo == 1) %>% ##Ja sao todos ativos
  rename (resultado = vr_nome) %>%
  collect()
##Pra filtrar os resultados da empresa
visita_resultado_empresa <- tbl(con, "visita_resultado_empresa") %>%
  select(vre_resultado_id, vre_empresa_id, vre_ativo) %>%
  filter(vre_ativo == 1, vre_empresa_id == empresa) %>% ##Ja sao todos ativos mas mantive pra manter o filtro, ja filtro a empresa
  collect()
#Arrumando encoding
Encoding(visita_resultado$resultado) <- 'latin1'

##junta as duas tabelas (resultado e resultado_empresa) pra pegar o id da empresa (vre_empresa_id) e o nome do resultado (vr_nome)
vis_res_emp <- inner_join(visita_resultado, visita_resultado_empresa, by = c('vr_id'= 'vre_resultado_id'))

##Pra pegar o nome do status
visita_status <- tbl(con,'visita_status') %>%
  select(vs_id, vs_nome, vs_ativo) %>%
  filter(vs_ativo == 1) %>%
  rename (motivo = vs_nome) %>%
  collect()
##Pra filtrar os status da empresa
visita_status_empresa <- tbl(con, "visita_status_empresa") %>%
  select(vse_status_id, vse_empresa_id, vse_ativo) %>%
  filter(vse_ativo == 1, vse_empresa_id == empresa) %>%
  collect()
#Arrumando encoding
Encoding(visita_status$motivo) <- 'latin1'

##coleta todos os vendedores
vendedor <- tbl(con, "vendedor") %>%
  select(vendedor_id, vendedor_nome, vendedor_id, vendedor_empresa_id, vendedor_ativo) %>%
  filter(vendedor_ativo == 1, vendedor_empresa_id == empresa) %>%
  collect()
#Arrumando encoding
Encoding(vendedor$vendedor_nome) <- 'latin1'
vendedor$vendedor_nome <- func_nome(vendedor$vendedor_nome)

if(empresa == 16){
  vendedor$vendedor_nome[vendedor$vendedor_id == 723] <- "BRUNO PE.";
  vendedor$vendedor_nome[vendedor$vendedor_id == 812] <- "BRUNO PO.";
  vendedor$vendedor_nome[vendedor$vendedor_id == 942] <- "LUCAS V. I.";
}


##junta as duas tabelas (status e status_empresa) pra pegar o id da empresa (vs_empresa_id) e o nome do status (vs_nome)
vis_st_emp <- inner_join(visita_status, visita_status_empresa, by = c('vs_id'= 'vse_status_id'))

##Juntando visita_cliente com os resultados
vc_ij_vre <- inner_join(visita_cliente, vis_res_emp, by = c('vc_resultado_id' = 'vr_id')) %>%
  select (vc_id, vc_vendedor_id, vc_resultado_id, resultado)
##Juntando visita_cliente com os motivos (status)
vc_ij_vse <- inner_join(visita_cliente, vis_st_emp, by = c('vc_status_id' = 'vs_id'))%>%
  select (vc_id, vc_vendedor_id, vc_status_id, motivo)

##juntando com vendedor pra separar por vendedor
vc_ij_vse_ij_v <- inner_join(vc_ij_vse, vendedor, by = c('vc_vendedor_id' = 'vendedor_id')) %>%
  select (vc_id, vc_vendedor_id, vendedor_nome, vc_status_id, motivo)

##juntando com vendedor pra separar por vendedor
vc_ij_vre_ij_v <- inner_join(vc_ij_vre, vendedor, by = c('vc_vendedor_id' = 'vendedor_id')) %>%
  select (vc_id, vc_vendedor_id, vendedor_nome, vc_resultado_id, resultado)

##Agrupando por vendedor e por motivo (vc_status_id, depois mostrar so motivo)
vc_ij_vse_ij_v <- vc_ij_vse_ij_v %>%
  group_by(vc_vendedor_id, vc_status_id) %>%
  mutate(motivo_n = n()) %>%
  distinct(vc_vendedor_id, .keep_all = T) %>%
  ungroup()

### Gráfico v0 - Motivo das visitas (status) por vendedor em 2020

##descobrindo numero de status diferentes para criar paleta de cores
n_m_color <- n_distinct(vc_ij_vse_ij_v$vc_status_id)
if (n_m_color <3){
  brbg_mot <- '#9ACD32'
} else{
  if(n_m_color > 11){
    brbg_mot <- colorRampPalette(brewer.pal(name="Dark2", n = 8)) (n_m_color)
  }else{
    brbg_mot <- brewer.pal(n_m_color,'BrBG')
  }
}

axis_h <- list(
  title = "")
v0 <- plot_ly(vc_ij_vse_ij_v, type = "bar", orientation = 'h', x = ~motivo_n, y = ~reorder(vendedor_nome, desc(vendedor_nome)), color = ~motivo,
              colors = brbg_mot,
              name = ~motivo)
v0 <- v0 %>%
  layout(barmode = 'stack',
         xaxis = list(title = '', tickangle = 30, tickfont = list(size = 11)),
         yaxis = list(title = ''))
if(dash == F){
  v0
}


##Agrupando por vendedor e por resultado (vc_status_id, depois mostrar so motivo)
vc_ij_vre_ij_v_ag <- vc_ij_vre_ij_v %>%
  group_by(vc_vendedor_id, vc_resultado_id) %>%
  mutate(resultado_n = n()) %>%
  distinct(vc_vendedor_id, .keep_all = T) %>%
  ungroup()

### Gráfico v1 - Resultado das visitas (resultados) por vendedor em 2020
##descobrindo numero de status diferentes para criar paleta de cores
n_r_color <- n_distinct(vc_ij_vre_ij_v_ag$vc_resultado_id)
if (n_r_color <3){
  brbg_res <- '#9ACD32'
} else{
  if(n_r_color > 11){
    brbg_res <- c(brewer.pal(name="Dark2", n = 8), brewer.pal(name="BrBG", n = 8))
  }else{
    brbg_res <- brewer.pal(n_m_color,'BrBG')
  }
}

v1 <- plot_ly(vc_ij_vre_ij_v_ag, type = "bar", orientation = 'h', x = ~resultado_n, y = ~reorder(vendedor_nome, desc(vendedor_nome)), color = ~resultado,
              colors = brbg_res,
              name = ~resultado)

v1 <- v1 %>%
  layout(barmode = 'stack',
         xaxis = list(title = '', tickangle = 30, tickfont = list(size = 11)),
         yaxis = list(title = ''))
if(dash == F){
  v1
}

if(teste == F){
  #tabelas
  rm(visita_resultado_empresa, vis_res_emp, vc_ij_vre, vc_ij_vse,
     ##vis_st_emp, vc_ij_vse_ij_v, ##vou usar a vis_st_emp para uma junção (saber qual empresa são feitas as visitas)
     vc_ij_vre_ij_v, vc_ij_vre_ij_v_ag, visita_resultado, visita_status, visita_status_empresa,
     axis_h);
  #variáveis
  rm(brbg_mot, brbg_res, n_r_color, n_m_color);
}

################################################################################################
################################################################################################
### Tabelas e graficos de Clientes

cliente <- tbl(con,'cliente') %>%
  select (cliente_id, cliente_vendedor_id, cliente_empresa_id, cliente_data_cadastro, cliente_cidade, cliente_ultima_visita) %>%
  filter(cliente_empresa_id == empresa) %>%
  collect()

##Clientes cadastrados por vendedor
cli_p_v <- cliente %>%
  group_by(cliente_vendedor_id) %>%
  mutate(n_clientes = n()) %>%
  distinct(cliente_vendedor_id, .keep_all = T) %>%
  select(cliente_vendedor_id, n_clientes) %>%
  arrange(cliente_vendedor_id) %>%
  ungroup()

##Juncao pra pegar nome do vendedor
cli_p_v_ij_vend <- inner_join(cli_p_v, vendedor, by = c('cliente_vendedor_id' = 'vendedor_id')) %>%
  select(cliente_vendedor_id, vendedor_nome, n_clientes)


##Já é filtrado em 2020 (filtra na tabela de visitas_cliente)
vc_ij_vse_ij_v_count <- vc_ij_vse_ij_v %>%
  select (vc_vendedor_id, motivo_n) %>% ##Não vou salvar o nome pq vou fazer uma junção com a outra tabela, então só preciso do id
  group_by(vc_vendedor_id) %>%
  mutate(n_visitas = sum(motivo_n)) %>%
  distinct(vc_vendedor_id, .keep_all = T) %>%
  ungroup ()

##Distribuição de clientes total, visita e negócios em 2020 por vendedor
vend_cli_vis <- left_join(cli_p_v_ij_vend, vc_ij_vse_ij_v_count, by = c("cliente_vendedor_id" = "vc_vendedor_id")) %>%
  select (cliente_vendedor_id, vendedor_nome, n_clientes, n_visitas)

##Contar quantos negócios são feitos por vendedor em 2020
negocio <- tbl(con, "negocio") %>%
  select(negocio_id, negocio_vendedor_id, negocio_cliente_id, negocio_data_cadastro) %>%
  filter(negocio_data_cadastro >= ano_atual) %>%
  collect()

##Juncao pra pegar a empresa do negócio (e vendedor)
neg_ij_vend <- inner_join(negocio, vendedor, by = c('negocio_vendedor_id' = 'vendedor_id')) %>%
  select(negocio_id, negocio_vendedor_id)

neg_ij_vend_count <- neg_ij_vend %>%
  select(negocio_vendedor_id) %>%
  group_by(negocio_vendedor_id) %>%
  mutate(n_negocios = n()) %>%
  distinct(negocio_vendedor_id, .keep_all = T) %>%
  ungroup()

vend_cli_vis_neg <- left_join(vend_cli_vis, neg_ij_vend_count, by = c("cliente_vendedor_id" = "negocio_vendedor_id")) %>%
  select (cliente_vendedor_id, vendedor_nome, n_clientes, n_visitas, n_negocios)

### Grafico c0 - Distribuicao de clientes (total), visitas (2020) e negocios (2020) cadastrados por vendedor
c0 <- plot_ly(vend_cli_vis_neg, x = ~vendedor_nome, y= ~n_clientes, type = 'bar',
              name = 'Clientes (total)')
c0 <- c0 %>%
  add_trace(y= ~n_visitas, name = 'Visitas (2020)')
c0 <- c0 %>%
  add_trace(y= ~n_negocios, name = 'Negócios (2020)')
c0 <- c0 %>%
 layout(barmode = 'grouped',
        xaxis = list(title = '', tickangle = 30, tickfont = list(size = 12)),
        yaxis = list(title = ''))

if(dash == F){
  c0
}

if(teste == F){
  #tabelas
  rm(cli_p_v, vend_cli_vis, vend_cli_vis_neg, neg_ij_vend, neg_ij_vend_count, vc_ij_vse_ij_v,
     vc_ij_vse_ij_v_count, cli_p_v_ij_vend);
  #variáveis
  rm();
}
### Gráficos de pizza de clientes com e sem negócio
##Contando número de clientes geral e em 2020
n_clientes <- nrow(cliente)
##Clientes cadastrados em 2020 por vendedor
cliente_2020 <- cliente %>%
  filter(cliente_data_cadastro >= ano_atual)
n_clientes_2020 <- nrow(cliente_2020)

##Contar quantos clientes aparecem em negócio
cli_ij_ng <- inner_join(cliente, negocio, by=c("cliente_id" = "negocio_cliente_id")) %>%
  select(cliente_id, negocio_id)
cli_2020_ij_ng <- inner_join(cliente_2020, negocio, by=c("cliente_id" = "negocio_cliente_id"))%>%
  select(cliente_id, negocio_id)
##Variáveis usadas
n_cli_cneg <- nrow(cli_ij_ng)
n_cli_cneg_2020 <- nrow(cli_2020_ij_ng)

Clientes <- c("Clientes com negócios", "Clientes sem negócio")

n_total <- c(n_cli_cneg, n_clientes-nrow(cli_ij_ng))
n_total_p <- c(round((n_cli_cneg/n_clientes), 2), round(((n_clientes-n_cli_cneg)/n_clientes), 2))

n_2020 <- c(n_cli_cneg_2020, n_clientes_2020-n_cli_cneg_2020)
n_2020_p <- c(round((n_cli_cneg_2020/n_clientes_2020), 2), round(((n_clientes_2020-n_cli_cneg_2020)/n_clientes_2020), 2))

cli_c_s_ng <- data.frame(Clientes, n_total, n_total_p, n_2020, n_2020_p)


### Grafico c1 - Clientes cadastrados que possuem negocio (pizza)
colors_pie<- c("#32CD32", "#FFA500")
c1 <- plot_ly(cli_c_s_ng, labels = ~Clientes, values = ~n_total, type = 'pie', sort = F,
              text = func_fmt_numbr(n_total),
              texttemplate = "%{text} (%{percent})",
              hovertemplate = paste ("%{label} <br>",
                                     "Equivalente a %{percent}",
                                     "<extra></extra>"),
              marker = list(colors = colors_pie))

if(dash == F){
  c1
}

### Grafico c2 - Clientes cadastrados em 2020 que possuem negocio (pizza)
c2 <- plot_ly(cli_c_s_ng, labels = ~Clientes, values = ~n_2020, type = 'pie', sort = F,
              text = func_fmt_numbr(n_2020),
              texttemplate = "%{text} (%{percent})",
              hovertemplate = paste ("%{label} <br>",
                                     "Equivalente a %{percent}",
                                     "<extra></extra>"),
              marker = list(colors = colors_pie))

if(dash == F){
  c2
}
if(teste == F){
  #tabelas
  rm(cli_ij_ng, cli_2020_ij_ng, cli_c_s_ng, Clientes, n_total, n_total_p, n_2020, n_2020_p, cliente_2020);
  #variáveis
  rm(n_cli_cneg, n_cli_cneg_2020, n_clientes, n_clientes_2020, colors_pie);
}
####################################


###Contar clientes/visitas/negocios cadastrados por mês -> vem do script visita_clientes
####################################

cliente <- tbl(con,'cliente') %>%
  select (cliente_id, cliente_vendedor_id, cliente_empresa_id, cliente_data_cadastro, cliente_cidade, cliente_ultima_visita) %>%
  filter(cliente_empresa_id == empresa) %>%
  collect()

##Collect cria o df resultado da query, nesse caso, visitas_cliente, já filtrando apenas ano atual
visita_cliente <- tbl(con,'visita_cliente') %>%
  select (vc_id, vc_vendedor_id, vc_cliente_id, vc_status_id, vc_resultado_id, vc_data_cadastro) %>%
  filter (vc_data_cadastro >= ano_atual) %>%
  collect ()

##Pra pegar o nome do status
visita_status <- tbl(con,'visita_status') %>%
  select(vs_id, vs_nome, vs_ativo) %>%
  filter(vs_ativo == 1) %>%
  rename (motivo = vs_nome) %>%
  collect()
##Pra filtrar os status da empresa
visita_status_empresa <- tbl(con, "visita_status_empresa") %>%
  select(vse_status_id, vse_empresa_id, vse_ativo) %>%
  filter(vse_ativo == 1, vse_empresa_id == empresa) %>%
  collect()
#Arrumando encoding
Encoding(visita_status$motivo) <- 'latin1'

##junta as duas tabelas (status e status_empresa) pra pegar o id da empresa (vs_empresa_id) e o nome do status (vs_nome)
vis_st_emp <- inner_join(visita_status, visita_status_empresa, by = c('vs_id'= 'vse_status_id'))

##Já filtrado apenas empresa (variavel global)
clientes_mes <- cliente %>%
  filter (cliente_data_cadastro >= ano_atual) %>%
  mutate (ym = format(cliente_data_cadastro, '%m')) %>%
  group_by (ym) %>%
  summarize(n_cli = n(), .groups = 'drop') %>%
  ungroup ()

##Visita precisa juntar com visita_status ou _resultado () pra obter empresa_id ##poderia ser vendedor, mas a tabela vis_st_emp (status c/ status_empresa) já está pronta
##vis_st_emp já vem filtrada pela empresa (var global)
vc_ij_emp <- inner_join(visita_cliente, vis_st_emp, by = c("vc_status_id" = "vs_id")) %>%
  #select(vc_id, vc_status_id, vc_data_cadastro) ##Sem empresa_id
  select(vc_id, vc_status_id, vc_data_cadastro, vse_empresa_id)

visitas_mes <- vc_ij_emp %>%
  filter (vc_data_cadastro >= ano_atual) %>%
  mutate (ym = format(vc_data_cadastro, '%m')) %>%
  group_by (ym) %>%
  summarize(n_vis = n(), .groups = 'drop') %>%
  ungroup ()

##Negocio precisa juntar com vendedor pra obter empresa_id ##Poderia ser cliente também, mas a tabela vendedor é menor
##vendedor já vem filtrado pela empresa (var global)
ng_ij_emp <- inner_join(negocio, vendedor, by = c("negocio_vendedor_id" = "vendedor_id")) %>%
  #select(negocio_id, negocio_vendedor_id, negocio_data_cadastro)%>% ##Sem empresa_id
  select(negocio_id, negocio_vendedor_id, negocio_data_cadastro, vendedor_empresa_id)

negocios_mes <- ng_ij_emp %>%
  filter (negocio_data_cadastro >= ano_atual) %>%
  mutate (ym = format(negocio_data_cadastro, '%m')) %>%
  group_by (ym) %>%
  summarize(n_neg = n(), .groups = 'drop') %>%
  ungroup ()

##Juntando tudo em um só dataframe
cli_ij_vc_mes <- inner_join(clientes_mes, visitas_mes, by = c("ym"))
cli_ij_vc_ij_ng_mes <- inner_join(cli_ij_vc_mes, negocios_mes, by = c("ym"))


##Criando nomes de colunas
meses = c('Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro')
## alterando pra números pra poder fazer da mesma forma
cli_ij_vc_ij_ng_mes$ym <- as.integer(cli_ij_vc_ij_ng_mes$ym)

##Vou usar dessa forma, ao invés de transformar, irei apenas criar uma nova coluna (poderia ser feito com um join também)
cli_ij_vc_ij_ng_mes <- cli_ij_vc_ij_ng_mes %>%
  mutate(mes = cut(ym,breaks = c(0,1,2,3,4,5,6,7,8, 9, 10, 11, 12),
                   labels = meses))
###Não farei dessa forma pois quero manter a coluna
#cli_ij_vc_ij_ng_mes$ym <- with(cli_ij_vc_ij_ng_mes, cut(ym, breaks = c(0,1,2,3,4,5,6,7,8, 9, 10, 11, 12),
#                                                        labels = meses))

### Gráfico c3 - Cadastro de clientes, visitas e negócios no ano de 2020
c3 <- plot_ly(cli_ij_vc_ij_ng_mes, type = 'scatter', mode = 'lines+markers', x = ~mes, y = ~n_cli,
              name = 'Clientes',
              text = ~paste(func_fmt_numbr(n_cli), 'clientes'),
              hoverinfo = "text",
              color = I('#7B68EE'))
c3 <- c3 %>%
  add_trace (type = 'scatter', mode = 'lines+markers', y = ~n_vis,
             name = 'Visitas',
             text = ~paste(func_fmt_numbr(n_vis), 'visitas'),
             hoverinfo = "text",
             color = I('#DAA520'))
c3 <- c3 %>%
  add_trace (type = 'scatter', mode = 'lines+markers', y = ~n_neg,
             name = 'Negócios',
             text = ~paste(func_fmt_numbr(n_neg), 'negócios'),
             hoverinfo = "text",
             color = I('green'))

c3 <- c3 %>%
  layout(xaxis = list(title = '', range = c(min(0), max(12))), ##Dessa forma pego os 12 meses do ano
         yaxis = list(title = ''))
if(dash == F){
  c3
}

if(teste == F){
  #tabelas
  rm(cliente, visita_cliente, negocio, vendedor, vis_st_emp, cli_ij_vc_mes, cli_ij_vc_ij_ng_mes,
     clientes_mes, negocios_mes, ng_ij_emp, visitas_mes, vc_ij_emp, visita_status, visita_status_empresa);
  #variáveis
  rm(meses);
}

#########################################################################################################
#########################################################################################################
##Começando scripts de mapas
#########################################################################################################
#########################################################################################################

cliente <- tbl(con,'cliente') %>%
  select (cliente_id, cliente_nome, cliente_latitude, cliente_longitude, cliente_empresa_id) %>%
  collect ()

#Arrumando encoding
Encoding(cliente$cliente_nome) <- 'latin1'

##Clientes da emprsa correta ##Clientes com valor NA, valores 0 e valores positivos de latlong (hemisf norte, leste do globo) removidos
cliente_c_loc <- cliente %>%
  filter (!is.null(cliente_latitude), !is.na(cliente_latitude), cliente_empresa_id == empresa, cliente_latitude < 0, cliente_longitude < 0) %>% 
  rename(lat = cliente_latitude, long = cliente_longitude) %>%
  mutate(lat = as.numeric(lat), long = as.numeric(long))

### Gráfico m0 de distribuição dos clientes por empresa
m0 <- leaflet(cliente_c_loc) %>% 
  addTiles() %>%
  addCircleMarkers(lat = ~lat, lng = ~long, weight = 1,
                   popup = paste0("Nome do cliente: ", ~cliente_nome),
                   label = ~cliente_nome,
                   clusterOptions = markerClusterOptions()
                   )

if(teste == F){
  #tabelas
  rm(cliente);
}

#######################################################################

##Parque de máquinas 
#######################################################################
parque_maquina <- tbl(con, 'parque_maquina') %>%
  select(pm_id, pm_cliente_id, pm_produto_id, pm_ano_modelo, pm_ativo) %>%
  filter (pm_ativo == 1) %>%
  collect()

##Vou selecionar produto_nome pra não ter q mudar depois, mas posso cortar essa coluna se preciso e ir só por prod_id
produto <- tbl(con, "produto") %>%
  select(produto_id, produto_nome, produto_marca_id, produto_categoria_id, produto_empresa_id) %>%
  #filter (produto_empresa_id == empresa) %>%
  collect()

##Vou selecionar produto_nome pra não ter q mudar depois, mas posso cortar essa coluna se preciso e ir só por prod_id
marca <- tbl(con, "marca") %>%
  select(marca_id, marca_nome) %>%
  #filter (produto_empresa_id == empresa) %>%
  collect()

cli_in_pm <- inner_join(cliente_c_loc, parque_maquina, by = c("cliente_id" = "pm_cliente_id")) %>%
  select (cliente_id, cliente_nome, lat, long, pm_id, pm_produto_id)

cli_in_pm_in_p <- inner_join(cli_in_pm, produto, by = c("pm_produto_id" = "produto_id")) %>%
  select (cliente_id, cliente_nome, lat, long, pm_id, pm_produto_id, produto_nome, produto_marca_id, produto_categoria_id, produto_empresa_id)

cli_in_pm_in_p_in_m <- inner_join(cli_in_pm_in_p, marca, by = c("produto_marca_id" = "marca_id")) %>%
  select (cliente_id, cliente_nome, lat, long, pm_id, pm_produto_id, produto_nome, produto_marca_id, marca_nome, produto_categoria_id, produto_empresa_id)

##Aqui obtenho todos os clientes e marcas, próximo passo é fazer o top5
cli_in_pm_cont <- cli_in_pm_in_p_in_m %>%
  select(cliente_id, cliente_nome, lat, long, produto_marca_id, marca_nome) %>%
  group_by(cliente_id, produto_marca_id) %>%
  mutate(cont = n()) %>%
  distinct (cliente_id, .keep_all = T) %>%
  ungroup()


##Criando o top5 de categorias
cli_in_pm_cont_top <- cli_in_pm_cont %>%
  group_by(marca_nome) %>%
  mutate(cont = n()) %>%
  distinct(marca_nome, .keep_all = T) %>%
  select (marca_nome, produto_marca_id, cont) %>%
  arrange(desc(cont)) %>%
  ungroup()


top5 <- head.matrix(cli_in_pm_cont_top, 5)
aux <- top5[,1]


cli_in_pm_cont_f <- cli_in_pm_cont %>%
  filter (marca_nome %in% aux$marca_nome)

n_color <- nrow(cli_in_pm_cont_f %>%
  group_by(produto_marca_id) %>%
  distinct(produto_marca_id) %>%
  ungroup())
##aleatório
#cores <- brewer.pal(n_color,'BrBG')
# Selecionadas por marca (NH, MF, JD, V, CI)
#cores <- c("#003E85","#E64439","#39832A","#FFC500","#000000")
#NH, CI, JD, MF, V
cores <- c("#003E85", "#808080","#39832A","#E64439","#FFC500")

cli_in_pm_cont_f <- cli_in_pm_cont_f %>%
  mutate(cor = NA)

top5 <- top5 %>%
  mutate(cor = NA)

#1,5,4,11,3
cli_in_pm_cont_f$cor <- with(cli_in_pm_cont_f, cut(as.integer(produto_marca_id), breaks = c(0,1,3,4,5,11), labels = cores))
top5$cor <- with(top5, cut(as.integer(produto_marca_id), breaks = c(0,1,3,4,5,11), labels = cores))


##Adicionando pequenas variações
cli_in_pm_cont_f$lat <- jitter(cli_in_pm_cont_f$lat, factor = .1, amount = 0)
cli_in_pm_cont_f$long <- jitter(cli_in_pm_cont_f$long, factor = .1, amount = 0)

### Gráfico m1 de distribuição das marcas (top5)
###################

m1 <- leaflet(cli_in_pm_cont_f) %>%
  addTiles() %>%
  addCircleMarkers(lat = ~lat, lng = ~long, weight = 1,
                   radius = ~cont*4,
                   popup = paste0("Nome do cliente: ", ~cliente_nome),
                   label = ~marca_nome,
                   color = ~cor,
                   #clusterOptions = markerClusterOptions(),
                   group = "Clientes agrupados"
                   ) %>%
  addLegend("topright",
            colors = top5$cor,
            labels = top5$marca_nome,
            title = 'Marcas',
             opacity = .8)

if(teste == F){
  #tabelas
  rm(cliente, cli_in_pm_cont_f, top5, n_color, aux, cli_in_pm_cont, cliente_c_loc,
     parque_maquina, produto, marca);
  #variáveis
  rm(cores);
}

###################
##Será usado apenas caso queira plotar todas as marcas como "Outros"
##Top5 + Outra, transformando as demais em OUTRA
for(i in 6:nrow(cli_in_pm_cont_top)){
  cli_in_pm_cont_top[i,1] <- 'OUTRAS*'
  cli_in_pm_cont_top[i,2] <- '-1'
}

##Criando o top5 (+ Outra) de categorias
cli_in_pm_cont_top_d <- cli_in_pm_cont_top %>%
  group_by(marca_nome) %>%
  mutate(sum = sum(cont)) %>%
  distinct(marca_nome, .keep_all = T) %>%
  select (marca_nome, produto_marca_id, sum) %>%
  arrange(desc(sum)) %>%
  ungroup()

cli_in_pm_cont_top_d <- cli_in_pm_cont_top_d %>%
  mutate(cor = NA)

##Adicionando a cor, de "OUTRAS*" -> Na ordem q ela aparece
cores <- c("#003E85", "#E64439", '#ACA593',"#39832A", "#FFC500","#808080")
##Preciso fazer os factores de modo automático
#cli_in_pm_cont_top_d$marca_nome = factor(cli_in_pm_cont_top_d$marca_nome, levels = c("NEW HOLLAND", "MASSEY FERGUSON", "OUTRAS*", "JOHN DEERE", "VALTRA", 'CASE IH'))
cli_in_pm_cont_top_d$marca_nome <- reorder(cli_in_pm_cont_top_d$marca_nome, desc(cli_in_pm_cont_top_d$sum))
### Gráfico m2 de distribuição das marcas (top5)
###################

m2 <- plot_ly(cli_in_pm_cont_top_d, type = 'bar', orientation = 'v',
              x = ~marca_nome,
              y = ~sum,
              color = ~marca_nome,
              colors = cores,
              showlegend = FALSE)

m2 <- m2 %>%
  layout(xaxis = list(title = ''),
         yaxis = list(title = ''))

if(dash == F){
  m2
}

if(teste == F){
  #tabelas
  rm(cli_in_pm_cont_top_d, cli_in_pm_cont_top, cli_in_pm_in_p_in_m, cli_in_pm_in_p, cli_in_pm);
  #variáveis
  rm(cores, i);
}

########################################################


```

Volume de visitas
=======================================================================

Column {data-width=550}
-----------------------------------------------------------------------

### Distribuição dos motivos das visitas por vendedor em 2020

```{r}

### Gráfico v0 - Motivo das visitas (status) por vendedor em 2020
v0

```

Column {data-width=550}
-----------------------------------------------------------------------

### Distribuição de resultado das visitas por vendedor em 2020

```{r}
### Gráfico v1 - Resultado das visitas (resultados) por vendedor em 2020
v1

```


Oportunidades
=======================================================================

Column {data-width=700}
-----------------------------------------------------------------------

### Distribuição do cadastro de clientes (total), visitas (2020), e negócios (2020) por vendedor

```{r}

### Grafico c0 - Distribuicao de clientes (total), visitas (2020) e negocios (2020) cadastrados por vendedor
c0

```

Column {data-width=400}
-----------------------------------------------------------------------

### Distribuição de clientes com ou sem negócios

```{r}

### Grafico c1 - Clientes cadastrados que possuem negocio (pizza)
c1

```



### Distribuição de clientes cadastrados em 2020 com ou sem negócios

```{r}

### Grafico c2 - Clientes cadastrados em 2020 que possuem negocio (pizza)
c2

```



Mapa de distribuição dos clientes
=======================================================================


```{r}
### Gráfico m0 de distribuição dos clientes
m0

```

Mapa de distribuição das marcas
=======================================================================

Column {data-width=750}
-----------------------------------------------------------------------

### Mapa das marcas
```{r}
### Gráfico m1 de distribuição das marcas (top5)
m1

```

Column {data-width=350}
-----------------------------------------------------------------------

### Distribuição das marcas
```{r}
### Gráfico m2 de distribuição das marcas
m2

```
